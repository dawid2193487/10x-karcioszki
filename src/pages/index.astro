---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import DashboardHeader from "../components/DashboardHeader.astro";
import EmptyState from "../components/EmptyState.astro";
import DeckGrid from "../components/DeckGrid.astro";
import type { DeckListResponseDTO } from "../types";
import { DeckService } from "../lib/services/deck.service";

// Check authentication through middleware
const supabase = Astro.locals.supabase;
const {
  data: { user },
  error: authError,
} = await supabase.auth.getUser();

if (!user || authError) {
  console.log("User not authenticated, redirecting to login.");
  return Astro.redirect("/login");
}

// Fetch user's decks (SSR) - call service directly since we're on the server
let decksData: DeckListResponseDTO | null = null;
let fetchError: string | null = null;

try {
  const deckService = new DeckService(supabase);
  decksData = await deckService.listDecks(user.id, { page: 1, limit: 10 });
} catch (error) {
  console.error("Error fetching decks:", error);
  fetchError = "Wystąpił błąd podczas ładowania danych";
}

const decks = decksData?.data || [];
const hasDecks = decks.length > 0;
---

<DashboardLayout user={user} decks={decks}>
  {fetchError && <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">{fetchError}</div>}

  {
    !fetchError && (
      <>
        <DashboardHeader />

        {hasDecks ? <DeckGrid decks={decks} /> : <EmptyState />}
      </>
    )
  }
</DashboardLayout>
